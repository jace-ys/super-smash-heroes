version: '3.5'

services:
  service.web-client:
    image: super-smash-heroes/service.web-client:latest
    container_name: service.web-client
    volumes:
      - ./services/web-client/nginx.conf:/etc/nginx/conf.d/default.conf
    labels:
      - "traefik.enable=true"
      - "traefik.backend=service.web-client"
      - "traefik.frontend.rule=Host:supersmashheroes.localhost"

  service.api-gateway:
    image: traefik:1.7.14-alpine
    restart: always
    container_name: service.api-gateway
    volumes:
      - ./services/traefik:/etc/traefik
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"

  service.rest-api:
    image: super-smash-heroes/service.rest-api:latest
    container_name: service.rest-api
    environment:
      - CONFIG_FILE=config/service-config.prod.yaml
    volumes:
      - ./config:/usr/src/app/config
    labels:
      - "traefik.enable=true"
      - "traefik.backend=service.rest-api"
      - "traefik.frontend.rule=PathPrefixStrip:/api/"

  service.superhero:
    image: super-smash-heroes/service.superhero:latest
    container_name: service.superhero
    env_file: .env
    environment:
      - CONFIG_FILE=config/service-config.prod.yaml
    volumes:
      - ./config:/usr/src/app/config

  service.battle:
    image: super-smash-heroes/service.battle:latest
    container_name: service.battle
    env_file: .env
    environment:
      - CONFIG_FILE=config/service-config.prod.yaml
    volumes:
      - ./config:/usr/src/app/config

  db.superhero:
    image: postgres:11.2-alpine
    container_name: db.superhero
    environment:
      - POSTGRES_PASSWORD=mysecretpassword
    volumes:
      - ./postgres/migrations:/docker-entrypoint-initdb.d
      - ./postgres/data:/var/lib/postgresql/data
